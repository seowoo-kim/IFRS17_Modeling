# IFRS17_Modeling



## 재보험평균출재율query최적화.md 파일 상세

### 테이블 구조

- 소스와 결과 테이블은 마감년월(CLO_YYMM)컬럼으로 메인파티셔닝하고 IFRS작업구분(IFRS_WRK_SECD)과 결산단계(MVMT_SECD)로 서브파티셔닝한다.(작업에 필요한 최소 세그먼트 단위 partitioning으로 I/O 부담 최소화)
- 평가년월(VALU_YYMM)은 마감년월과 다르다. 평가년월은 평가의 시작시점을 의미하지만, 마감년월은 현재 가지고 있는 기초 통계 정보와 가정에 대한 기준연월이자 결산연월을 의미한다. 예로 마감년월이 201812이지만 평가년월이 201810인 경우, 201812에 실현되어 조정된 정보를 이용해서 201810시점부터 다시 평가해보는 것이다.
- 소스1과 소스2는 변경이 잦기 때문에 작업시에는 사용 대상만을 특정하기 위한 최신여부와 사용불가여부 두개의 flag 컬럼과 조건을 둔다.(LAST_HIS_YN ='1' AND DEL_YN ='0')

### 재보험 평균 출재율 쿼리 최적화 복기

grouping set을 쓰지 않더라도 materialize 힌트를 작성하여 직접 유도할 수도 있다. 그러나 인라인뷰가 많고 복잡한 병렬구조로 되어 있다면, DB parameter, query view merge, 또는 선행하는 힌트로 인해 materialize가 무시될 여지가 있다. 쿼리가 복잡할수록 옵티마이저의 유도가 힘들기 때문에 가급적이면 grouping set을 명시적으로 사용하여서 materialize 구조를 우선 고려하도록 한다.

여러 기준을 이용한 다중 grouping을 진행할때 다음을 고려함이 현명하다.

- 업무요건과 통계정보, 그리고 예상 result set을 고려하여 full scan을 몇 번 진행 할것인지 결정한다.
    - 예로 Oracle exadata는 Cell Offloading기술로 직접 스캔속도가 매우 빠르기 때문에, 해시필터링 이후 나온 배열이 작다면 full scan을 여러번 수행하는 것도 현명한 생각이다.
    - 오히려 스캔 횟수를 줄이고 집계 방식을 복잡하게 만들어서 Temp-tablespace를 많이 사용하게 된다면, undo/redo/다른임시작업성 레코드 들과의 충돌도 고려해야하는 단점이 있다. 예로 동시진행중인 각 업무별로 얼마나 메모리와 디스크를 할당할 것인지 db parameter 재설정을 고려해야한다. 게다가 메모리와 temp tablespace간의 잦은 자료 교환으로 속도가 느려지고, 작업간 DB snapshot 영역 덮어쓰기, 다른 작업과 얽힌 DB hanging이 발생할 수 있으므로 전략적인 반복 full scan도 고려해야한다.
    - 물론 full scan을 효과적으로 하기 위해서는 사용중인 시스템의 성능과 물리적인 구조(파티셔닝, 서브파티셔닝, 클러스터형인덱스, 인덱스 풀스캔 등)를 고려해야 한다.
- 필터링 구조를 고려해야 한다.(서브쿼리의 조인이나 filter operation, bloom filter 등)
- 집계 알고리즘을 고려해야 한다.(정렬기법을 포함하여 inmemory 정렬 할 수 있는가, 해싱기법이 아니라면 정렬할때 몇 개의 기준이 해당 그룹핑을 전제하기에 충분한가)
- 최종 결과물의 result set의 크기와 데이터 특징을 고려해야 한다.
