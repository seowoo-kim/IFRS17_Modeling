```sql

SET TIMING ON;

--07.21이 05.22로부터 변경된 점은 BFRT_INF 테이블에 CLO_YYMM 컬럼이 추가된것 뿐임.

SELECT * FROM MIG.FND_RKRT_INF WHERE LAST_HIS_YN ='1' AND DEL_YN ='0';
--RISK_RATE   --SOURCE2
SELECT * FROM CF_SIMU.IFRS_BFRT_CRT_LST WHERE CLO_YYMM ='201812' AND LAST_HIS_YN ='1' AND DEL_YN ='0';
--GEN_BENRATE   --SOURCE1
SELECT * FROM CF_SIMU.BFRT_INF;
--BEN_RATE    TARGET
--RISK RATE TABLE에 CLO_YYMM이 없음. 주의해야함


--UNION 때문에 애초에 동일키에대한 중복건(예를들어 동일담보코드에 계산법이 여러개라던가, 혹은 위험률코드가 다르다던가)이 있다면 PK중복에러가 나면서 데이터 INSERT 자체가 불가능할것임.
--만약 에러가 난다면 아래의 계산법 중복확인, 위험률코드 중복확인 쿼리수행해서 확인할것

--SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);
--EXPLAIN PLAN FOR

INSERT /*+ENABLE_PARALLEL_DML PARALLEL(Z 16) OPT_PARAM('_OPTIMIZER_GATHER_STATS_ON_LOAD' 'FALSE') PQ_DISTRIBUTE(Z NONE)*/ 
INTO CF_SIMU.BFRT_INF Z         --아래에 입력해야하는 마감년월에 맞춰서 CLO_YYMM 변경해줘야함. 07.21기준
SELECT /*+PARALLEL(A 16)*/ '201812' AS CLO_YYMM, A.IFRS_CLM_ID, A.GNDR_APPT_COD, A.AGE, CASE WHEN ROUND_OPT = '1' THEN ROUND(XMLQUERY(STD_RKRT_CALFM_RMK RETURNING CONTENT).GETNUMBERVAL(), 6) ELSE XMLQUERY(STD_RKRT_CALFM_RMK RETURNING CONTENT).GETNUMBERVAL() END AS RKRT_VL 
FROM 
    (SELECT /*+PARALLEL(A 16)*/
          A.IFRS_CLM_ID, REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(STD_RKRT_CALFM_RMK, 'q1', Q1), 'q2', Q2), 'q3', Q3), 'q4', Q4), 'q5', Q5), 'q6', Q6), 'q7', Q7), 'q8', Q8), 'q9', Q9), '/', ' div '), 'Round', 'fn:round-half-to-even'), 'x', '*'), 'q', 1) AS STD_RKRT_CALFM_RMK
          , A.GNDR_APPT_COD, A.AGE, A.ROUND_OPT
    FROM 
        (SELECT /*+FULL(A) PARALLEL(A 16) FULL(B) PARALLEL(B 16) USE_HASH(A B) USE_HASH(B A) SWAP_JOIN_INPUTS(B) PQ_DISTRIBUTE(A HASH HASH) NO_PX_JOIN_FILTER(A) USE_CONCAT*/
               B.STD_IFRS_CLM_ID AS IFRS_CLM_ID, B.STD_RKRT_CALFM_RMK, A.GNDR_APPT_COD, A.AGE
               , NVL(MAX(CASE WHEN A.RKRT_COD = B.STD_RKRT_1_ID THEN RKRT END), 0) AS Q1
               , NVL(MAX(CASE WHEN A.RKRT_COD = B.STD_RKRT_2_ID THEN RKRT END), 0) AS Q2
               , NVL(MAX(CASE WHEN A.RKRT_COD = B.STD_RKRT_3_ID THEN RKRT END), 0) AS Q3
               , NVL(MAX(CASE WHEN A.RKRT_COD = B.STD_RKRT_4_ID THEN RKRT END), 0) AS Q4
               , NVL(MAX(CASE WHEN A.RKRT_COD = B.STD_RKRT_5_ID THEN RKRT END), 0) AS Q5
               , NVL(MAX(CASE WHEN A.RKRT_COD = B.STD_RKRT_6_ID THEN RKRT END), 0) AS Q6
               , NVL(MAX(CASE WHEN A.RKRT_COD = B.STD_RKRT_7_ID THEN RKRT END), 0) AS Q7
               , NVL(MAX(CASE WHEN A.RKRT_COD = B.STD_RKRT_8_ID THEN RKRT END), 0) AS Q8
               , NVL(MAX(CASE WHEN A.RKRT_COD = B.STD_RKRT_9_ID THEN RKRT END), 0) AS Q9
               , MAX(CASE WHEN A.RKRT_COD IN ('28Z167B2220', '28Z167B2221', '28Z167B2222') THEN '1' ELSE '0' END) AS ROUND_OPT
        FROM 
            (SELECT /*+PARALLEL(B 16) NO_MERGE*/ STD_IFRS_CLM_ID, STD_RKRT_CALFM_RMK, STD_RKRT_1_ID, STD_RKRT_2_ID, STD_RKRT_3_ID, STD_RKRT_4_ID, STD_RKRT_5_ID, STD_RKRT_6_ID, STD_RKRT_7_ID, STD_RKRT_8_ID, STD_RKRT_9_ID
            FROM 
                (SELECT /*+FULL(A) PARALLEL(A 16) */ STD_IFRS_CLM_ID, STD_ACCT_PYMT_COD, STD_RKRT_CALFM_RMK
                      , STD_RKRT_1_ID
                      , STD_RKRT_2_ID
                      , STD_RKRT_3_ID
                      , STD_RKRT_4_ID
                      , STD_RKRT_5_ID
                      , STD_RKRT_6_ID
                      , STD_RKRT_7_ID
                      , STD_RKRT_8_ID
                      , STD_RKRT_9_ID 
                FROM CF_SIMU.IFRS_BFRT_CRT_LST A WHERE CLO_YYMM ='201812' AND LAST_HIS_YN ='1' AND DEL_YN ='0'
                UNION
                SELECT /*+FULL(A) PARALLEL(A 16) */ ONLVL_IFRS_CLM_ID AS STD_IFRS_CLM_ID, ONLVL_ACCT_PYMT_COD AS STD_ACCT_PYMT_COD, ONLVL_RKRT_CALFM_RMK AS STD_RKRT_CALFM_RMK
                      , ONLVL_RKRT_1_ID AS STD_RKRT_1_ID
                      , ONLVL_RKRT_2_ID AS STD_RKRT_2_ID
                      , ONLVL_RKRT_3_ID AS STD_RKRT_3_ID
                      , ONLVL_RKRT_4_ID AS STD_RKRT_4_ID
                      , ONLVL_RKRT_5_ID AS STD_RKRT_5_ID
                      , ONLVL_RKRT_6_ID AS STD_RKRT_6_ID
                      , ONLVL_RKRT_7_ID AS STD_RKRT_7_ID
                      , ONLVL_RKRT_8_ID AS STD_RKRT_8_ID
                      , ONLVL_RKRT_9_ID AS STD_RKRT_9_ID 
                FROM CF_SIMU.IFRS_BFRT_CRT_LST A WHERE CLO_YYMM ='201812' AND LAST_HIS_YN ='1' AND DEL_YN ='0'
                )B 
            )B
            , MIG.FND_RKRT_INF A
        WHERE A.MIG_CLO_YYMM ='201812' AND A.LAST_HIS_YN ='1' AND A.DEL_YN ='0' AND A.RKRT_COD IN (B.STD_RKRT_1_ID, B.STD_RKRT_2_ID, B.STD_RKRT_3_ID, B.STD_RKRT_4_ID, B.STD_RKRT_5_ID, B.STD_RKRT_6_ID, B.STD_RKRT_7_ID, B.STD_RKRT_8_ID, B.STD_RKRT_9_ID) 
        GROUP BY B.STD_IFRS_CLM_ID, B.STD_RKRT_CALFM_RMK, A.GNDR_APPT_COD, A.AGE
        ) A 
    ) A
;
COMMIT;


----------------------------동일담보 계산법상이 DEBUG. 현재 0422기준 없음.
SELECT /*+PARALLEL(A 16) */ CLM_ID
FROM 
    (SELECT /*+PARALLEL(A 16) */ CLM_ID, CALFM_RMK 
    FROM 
        (SELECT /*+PARALLEL(A 16) */ CLM_NUM, CLM_ID, CASE WHEN CLM_NUM ='STD_IFRS_CLM_ID' THEN STD_RKRT_CALFM_RMK WHEN CLM_NUM ='ONLVL_IFRS_CLM_ID' THEN ONLVL_RKRT_CALFM_RMK END AS CALFM_RMK  
        FROM 
            (SELECT /*+FULL(A) PARALLEL(A 16) */ CLM_NUM, CLM_ID, STD_RKRT_CALFM_RMK, ONLVL_RKRT_CALFM_RMK
            FROM (SELECT * FROM CF_SIMU.IFRS_BFRT_CRT_LST WHERE CLO_YYMM ='201812' AND LAST_HIS_YN ='1' AND DEL_YN ='0') A
            UNPIVOT(CLM_ID FOR CLM_NUM IN (STD_IFRS_CLM_ID, ONLVL_IFRS_CLM_ID)) 
            ) A 
        ) A 
    GROUP BY CLM_ID, CALFM_RMK
    ) A 
GROUP BY CLM_ID HAVING COUNT (*) > 1
; 

----------------------------동일담보 위험률 상이 DEBUG. 현재 0422기준 없음.
SELECT /*+PARALLEL(A 16)*/ STD_IFRS_CLM_ID 
FROM
    (SELECT /*+FULL(A) PARALLEL(A 16) */ STD_IFRS_CLM_ID, (STD_RKRT_1_ID||STD_RKRT_2_ID||STD_RKRT_3_ID||STD_RKRT_4_ID||STD_RKRT_5_ID||STD_RKRT_6_ID||STD_RKRT_7_ID||STD_RKRT_8_ID||STD_RKRT_9_ID) AS CHK
    FROM CF_SIMU.IFRS_BFRT_CRT_LST A WHERE CLO_YYMM ='201812' AND LAST_HIS_YN ='1' AND DEL_YN ='0'
    UNION
    SELECT /*+FULL(A) PARALLEL(A 16) */ ONLVL_IFRS_CLM_ID AS STD_IFRS_CLM_ID, (ONLVL_RKRT_1_ID||ONLVL_RKRT_2_ID||ONLVL_RKRT_3_ID||ONLVL_RKRT_4_ID||ONLVL_RKRT_5_ID||ONLVL_RKRT_6_ID||ONLVL_RKRT_7_ID||ONLVL_RKRT_8_ID||ONLVL_RKRT_9_ID) AS CHK
    FROM CF_SIMU.IFRS_BFRT_CRT_LST A WHERE CLO_YYMM ='201812' AND LAST_HIS_YN ='1' AND DEL_YN ='0'
    )
GROUP BY STD_IFRS_CLM_ID HAVING COUNT(*) > 1;




----------------------------누락위험률코드건 DEBUG. 현재 0422기준 5건 나옴.
SELECT RKRT_COD 
FROM 
    (SELECT /*+PARALLEL(B 16) PARALLEL(A 16) */ A.RKRT_COD, B.RKRT_COD AS NULL_CHK 
    FROM
        (SELECT /*+PARALLEL(A 16) */ DISTINCT RKRT_ID AS RKRT_COD
        FROM
            (SELECT /*+FULL(A) PARALLEL(A 16) */ RKRT_ID, ID_NUM
            FROM (SELECT * FROM CF_SIMU.IFRS_BFRT_CRT_LST WHERE CLO_YYMM ='201812' AND LAST_HIS_YN ='1' AND DEL_YN ='0') A
            UNPIVOT(RKRT_ID FOR ID_NUM IN(STD_RKRT_1_ID, STD_RKRT_2_ID, STD_RKRT_3_ID, STD_RKRT_4_ID, STD_RKRT_5_ID, STD_RKRT_6_ID, STD_RKRT_7_ID, STD_RKRT_8_ID, STD_RKRT_9_ID
                                      , ONLVL_RKRT_1_ID, ONLVL_RKRT_2_ID, ONLVL_RKRT_3_ID, ONLVL_RKRT_4_ID, ONLVL_RKRT_5_ID, ONLVL_RKRT_6_ID, ONLVL_RKRT_7_ID, ONLVL_RKRT_8_ID, ONLVL_RKRT_9_ID)) A
            )
        ) A
        , (SELECT /*+FULL(A) PARALLEL(A 16)*/ DISTINCT RKRT_COD AS RKRT_COD FROM MIG.FND_RKRT_INF A WHERE LAST_HIS_YN ='1' AND DEL_YN ='0') B
    WHERE A.RKRT_COD = B.RKRT_COD (+)
    ) 
WHERE NULL_CHK IS NULL;

----------------------------누락위험률 사용하는 급부코드건 DEBUG. 현재 0422기준 7건 나옴. 담보코드 내 위험률코드가 전부 누락된 것이 아니라 일부만 누락되어서 MIG에 없는 경우라면, 누락 위험률은 0으로 넣고 다른 위험률들과 계산해서 넣음.
SELECT DISTINCT STD_IFRS_CLM_ID 
FROM 
    (SELECT /*+PARALLEL(B 16) PARALLEL(A 16) */ A.STD_IFRS_CLM_ID, B.RKRT_COD AS NULL_CHK 
    FROM
        (SELECT /*+PARALLEL(A 16) */  DISTINCT A.CLM_ID AS STD_IFRS_CLM_ID, A.RKRT_ID AS RKRT_COD
        FROM
            (SELECT /*+FULL(A) PARALLEL(A 16) */ CLM_ID, CLM_NUM, RKRT_ID, ID_NUM
            FROM
                (SELECT /*+FULL(A) PARALLEL(A 16) */ STD_IFRS_CLM_ID, ONLVL_IFRS_CLM_ID, RKRT_ID, ID_NUM
                FROM (SELECT * FROM CF_SIMU.IFRS_BFRT_CRT_LST WHERE CLO_YYMM ='201812' AND LAST_HIS_YN ='1' AND DEL_YN ='0') A
                UNPIVOT(RKRT_ID FOR ID_NUM IN(STD_RKRT_1_ID, STD_RKRT_2_ID, STD_RKRT_3_ID, STD_RKRT_4_ID, STD_RKRT_5_ID, STD_RKRT_6_ID, STD_RKRT_7_ID, STD_RKRT_8_ID, STD_RKRT_9_ID
                                              , ONLVL_RKRT_1_ID, ONLVL_RKRT_2_ID, ONLVL_RKRT_3_ID, ONLVL_RKRT_4_ID, ONLVL_RKRT_5_ID, ONLVL_RKRT_6_ID, ONLVL_RKRT_7_ID, ONLVL_RKRT_8_ID, ONLVL_RKRT_9_ID)) A
                ) A
            UNPIVOT(CLM_ID FOR CLM_NUM IN (STD_IFRS_CLM_ID, ONLVL_IFRS_CLM_ID))
            ) A
        ) A
        , (SELECT /*+FULL(A) PARALLEL(A 16)*/ DISTINCT RKRT_COD AS RKRT_COD FROM MIG.FND_RKRT_INF A WHERE LAST_HIS_YN ='1' AND DEL_YN ='0') B
    WHERE A.RKRT_COD = B.RKRT_COD (+)
    )
WHERE NULL_CHK IS NULL;
            

----------------------------그래서 누락위험률을 사용한 담보코드를 모두 넣으면 중복문제가 생김. 없는 담보코드만 넣어야하기에 TARGET TABLE과 조인후 NULL CHK를 진행함.
SELECT * FROM BFRT_INF;

--SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY('PLAN_TABLE', NULL, 'OUTLINE'));
--EXPLAIN PLAN FOR

INSERT /*+ENABLE_PARALLEL_DML APPEND PARALLEL(Z 16) PQ_DISTRIBUTE(Z NONE)*/
INTO CF_SIMU.BFRT_INF Z
SELECT '201812' AS CLO_YYMM, A.STD_IFRS_CLM_ID, B.GNDR_APPT_COD, B.AGE, 0 AS RKRT_VL                --입력해야하는 마감년월에 맞춰서 CLO_YYMM 변경해줘야함. 07.21기준
FROM
    (SELECT /*+PARALLEL(A 16) */ STD_IFRS_CLM_ID
    FROM
        (SELECT /*+PARALLEL(A 16) PARALLEL(B 16) ORDERED USE_HASH(A B)*/ A.STD_IFRS_CLM_ID, B.IFRS_CLM_ID
        FROM
            (SELECT DISTINCT STD_IFRS_CLM_ID 
            FROM 
                (SELECT /*+PARALLEL(B 16) PARALLEL(A 16) */ A.STD_IFRS_CLM_ID, B.RKRT_COD AS NULL_CHK 
                FROM
                    (SELECT /*+PARALLEL(A 16) */  DISTINCT A.CLM_ID AS STD_IFRS_CLM_ID, A.RKRT_ID AS RKRT_COD
                    FROM
                        (SELECT /*+FULL(A) PARALLEL(A 16) */ CLM_ID, CLM_NUM, RKRT_ID, ID_NUM
                        FROM
                            (SELECT /*+FULL(A) PARALLEL(A 16) */ STD_IFRS_CLM_ID, ONLVL_IFRS_CLM_ID, RKRT_ID, ID_NUM
                            FROM (SELECT * FROM CF_SIMU.IFRS_BFRT_CRT_LST WHERE CLO_YYMM ='201812' AND LAST_HIS_YN ='1' AND DEL_YN ='0') A
                            UNPIVOT(RKRT_ID FOR ID_NUM IN(STD_RKRT_1_ID, STD_RKRT_2_ID, STD_RKRT_3_ID, STD_RKRT_4_ID, STD_RKRT_5_ID, STD_RKRT_6_ID, STD_RKRT_7_ID, STD_RKRT_8_ID, STD_RKRT_9_ID
                                                          , ONLVL_RKRT_1_ID, ONLVL_RKRT_2_ID, ONLVL_RKRT_3_ID, ONLVL_RKRT_4_ID, ONLVL_RKRT_5_ID, ONLVL_RKRT_6_ID, ONLVL_RKRT_7_ID, ONLVL_RKRT_8_ID, ONLVL_RKRT_9_ID)) A
                            ) A
                        UNPIVOT(CLM_ID FOR CLM_NUM IN (STD_IFRS_CLM_ID, ONLVL_IFRS_CLM_ID))
                        ) A
                    ) A
                    , (SELECT /*+FULL(A) PARALLEL(A 16)*/ DISTINCT RKRT_COD AS RKRT_COD FROM MIG.FND_RKRT_INF A WHERE LAST_HIS_YN ='1' AND DEL_YN ='0') B
                WHERE A.RKRT_COD = B.RKRT_COD (+)
                )
            WHERE NULL_CHK IS NULL
            ) A
            , (SELECT /*+FULL(A) PARALLEL(A 16) */ DISTINCT IFRS_CLM_ID FROM CF_SIMU.BFRT_INF A) B
        WHERE A.STD_IFRS_CLM_ID = B.IFRS_CLM_ID (+)
        ) A
    WHERE IFRS_CLM_ID IS NULL
    ) A
    , (SELECT FLOOR((LEVEL - 1 ) / 120) + 1 AS GNDR_APPT_COD, MOD((LEVEL - 1 ), 120) + 1 AS AGE FROM DUAL CONNECT BY LEVEL < 241) B
;
COMMIT;


SELECT COUNT(DISTINCT IFRS_CLM_ID) FROM CF_SIMU.BFRT_INF;
--4934
SELECT COUNT(*) FROM CF_SIMU.BFRT_INF;
--1194028


```