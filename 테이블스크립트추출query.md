```sql

--RANGE PARTITIONING 기준으로 작성함.
--일부 테이블 임시테이블로 생성 시, 개발계에 followup table생성 시 이용함. 요건별 스냅샷처럼 백업용으로도 사용할 수 있음.
--테이블 스크립트 생성하여 전달할 목적으로 만듬.

--###1.테이블DDL, MIG_CLO_YYMM(마감회계년월)으로 PARTITIONING 구성함.
SELECT TABLE_PROPERTY FROM (
SELECT OWNER, TABLE_NAME, 1 AS NUM, COLUMN_ID, (CASE WHEN COLUMN_ID = 1 THEN 'CREATE TABLE '||OWNER||'.'||TABLE_NAME||'( ' ELSE ',' END)||COLUMN_NAME||' '||DATA_TYPE||(CASE WHEN DATA_TYPE NOT IN('TIMESTAMP(6)', 'DATE') THEN '( ' END)||(CASE WHEN DATA_TYPE IN('CHAR', 'VARCHAR2') THEN CAST(DATA_LENGTH AS VARCHAR2(10))
                                               WHEN DATA_TYPE ='NUMBER' THEN CAST(DATA_PRECISION AS VARCHAR2(10))||','||CAST(DATA_SCALE AS VARCHAR2(10)) ELSE NULL END)
       ||(CASE WHEN DATA_TYPE IN ('CHAR', 'VARCHAR2') THEN ' BYTE' END)||(CASE WHEN DATA_TYPE NOT IN('TIMESTAMP(6)', 'DATE') THEN ') ' END)||(CASE WHEN NULLABLE = 'N' THEN ' NOT NULL' END)||(CASE WHEN COLUMN_ID = MAX_ID THEN ') PARTITION BY RANGE (MIG_CLO_YYMM)  ' END) AS TABLE_PROPERTY
FROM (SELECT MAX(COLUMN_ID) OVER(PARTITION BY OWNER, TABLE_NAME) MAX_ID , A.* FROM ALL_TAB_COLUMNS A)
WHERE TABLE_NAME IN ('SPEL_RKRT_INF')     -- A.TABLE_NAME 수정할것, 현재는 임시테이블
UNION ALL
SELECT B.OWNER, B.TABLE_NAME, 2 AS NUM, ADD_M AS COLUMN_ID, (CASE WHEN ADD_M <> 1 THEN ',' ELSE '(' END)||'PARTITION PT'||PT_M||' VALUES LESS THAN ('||''''||LESS_M||''''||')'||(CASE WHEN ADD_M = 60 THEN ') TABLESPACE TSD_'||B.OWNER||' NOLOGGING;' END) AS TABLE_PROPERTY FROM( -- 파티션길이 두행아래에서 수정한 부분 -1로 수정할것
SELECT ADD_M, TO_CHAR(ADD_MONTHS(TO_DATE('201712', 'YYYYMM'), ADD_M -1), 'YYYYMM') AS PT_M,TO_CHAR(ADD_MONTHS(TO_DATE('201712', 'YYYYMM'), ADD_M), 'YYYYMM') AS LESS_M FROM (
SELECT LEVEL AS ADD_M FROM DUAL CONNECT BY LEVEL < 61)) A, ALL_TABLES B    -- 파티션길이 50부분 수정할것, 필요에따라서 파티셔닝 단위를 맞출것, 세그먼트낭비 피하기, 대략 4개년치로진행함.
WHERE B.TABLE_NAME IN ('SPEL_RKRT_INF')     --A.TABLE_NAME 수정할것, 현재는 임시테이블
)
ORDER BY OWNER, TABLE_NAME, NUM, COLUMN_ID;


--###2.인덱스DDL
SELECT QUERY_STRING FROM
(SELECT A.INDEX_NAME, 1 AS NUM, 'CREATE '||(CASE WHEN A.UNIQUENESS ='UNIQUE' THEN 'UNIQUE' END)||' INDEX '||A.OWNER||'.'||A.INDEX_NAME||' ON '||A.OWNER||'.'||A.TABLE_NAME||'('||B.STR
      ||') LOCAL TABLESPACE TSD_'||A.OWNER||' NOLOGGING;' AS QUERY_STRING
FROM ALL_INDEXES A ,
     (SELECT INDEX_OWNER, INDEX_NAME, TABLE_NAME, LISTAGG(COLUMN_NAME, ',') WITHIN GROUP (ORDER BY COLUMN_POSITION) AS STR FROM ALL_IND_COLUMNS WHERE TABLE_NAME ='TT_RSUR_TRT_BAS_1212'
     GROUP BY INDEX_OWNER, INDEX_NAME, TABLE_NAME) B 
WHERE A.TABLE_NAME ='TT_RSUR_TRT_BAS_1212' AND A.OWNER = B.INDEX_OWNER AND A.INDEX_NAME = B.INDEX_NAME AND A.TABLE_NAME = B.TABLE_NAME    -- A.TABLE_NAME 수정할것, 현재는 임시테이블
UNION ALL
SELECT A.INDEX_NAME, 2 AS NUM, 'ALTER TABLE '||A.OWNER||'.'||A.TABLE_NAME||' ADD CONSTRAINT '||A.INDEX_NAME||' PRIMARY KEY('||B.STR
        ||') USING INDEX '||A.OWNER||'.'||A.INDEX_NAME||' ;' 
        AS QUERY_STRING
FROM ALL_INDEXES A ,
     (SELECT INDEX_OWNER, INDEX_NAME, TABLE_NAME, LISTAGG(COLUMN_NAME, ',') WITHIN GROUP (ORDER BY COLUMN_POSITION) AS STR FROM ALL_IND_COLUMNS WHERE TABLE_NAME ='TT_RSUR_TRT_BAS_1212'     -- A.TABLE_NAME 수정할것
     GROUP BY INDEX_OWNER, INDEX_NAME, TABLE_NAME) B 
WHERE ((A.INDEX_NAME LIKE '%_PK') OR (A.TABLE_NAME LIKE 'PK_%')) AND A.TABLE_NAME ='TT_RSUR_TRT_BAS_1212' AND A.OWNER = B.INDEX_OWNER AND A.INDEX_NAME = B.INDEX_NAME AND A.TABLE_NAME = B.TABLE_NAME) A    -- A.TABLE_NAME 수정할것, 현재는 임시테이블
ORDER BY A.INDEX_NAME, A.NUM;


--###3.COMMENT
SELECT COMMENT_STRING FROM 
(SELECT A.OWNER, 1 AS NUM, TABLE_NAME, 'COMMENT ON TABLE '||A.OWNER||'.'||A.TABLE_NAME||' IS '||''''||A.COMMENTS||''''||';' AS COMMENT_STRING FROM ALL_TAB_COMMENTS A
WHERE TABLE_NAME ='TT_RSUR_TRT_BAS_1212' AND TABLE_TYPE ='TABLE'    -- A.TABLE_NAME 수정할것, 현재는 임시테이블
UNION ALL
SELECT A.OWNER, 2 AS NUM, A.TABLE_NAME, 'COMMENT ON COLUMN '||A.OWNER||'.'||A.TABLE_NAME||'.'||A.COLUMN_NAME||' IS '||''''||A.COMMENTS||''''||';' AS COMMENT_STRING FROM ALL_COL_COMMENTS A,
ALL_TAB_COLUMNS B WHERE A.TABLE_NAME ='TT_RSUR_TRT_BAS_1212' AND A.TABLE_NAME = B.TABLE_NAME AND A.OWNER = B.OWNER AND A.COLUMN_NAME= B.COLUMN_NAME)   -- A.TABLE_NAME 수정할것, 현재는 임시테이블
ORDER BY OWNER, TABLE_NAME, NUM;


--###4.GRANT
GRANT SELECT, DELETE, UPDATE, INSERT ON SCHEMA0.RSUR_TRT_BAS TO USER; --현재는 임시테이블이므로 맞춰서 수정할 것.
GRANT SELECT, DELETE, UPDATE, INSERT ON SCHEMA0.RSUR_TRT_BAS TO SCHEMA1_DML; --유저와는 별개로 데이터를 들고 있는 스키마별로 각각의 필요 접근 객체에 dml 권한을 부여함.
GRANT SELECT, DELETE, UPDATE, INSERT ON SCHEMA0.RSUR_TRT_BAS TO SCHEMA2_DML;


```
