```sql

SET TIMING ON;

SELECT * FROM CF_SIMU.VFA_APPT_REQS_LST;          --변동수수료법적용요건내역
SELECT * FROM CF_SIMU.VFA_JUDG_RTO_LST;           --변동수수료법판단비율내역

DELETE FROM CF_SIMU.VFA_JUDG_RTO_LST;
COMMIT;
ROLLBACK;

--SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY('PLAN_TABLE', NULL, 'OUTLINE'));
--EXPLAIN PLAN FOR

INSERT /*+ENABLE_PARALLEL_DML PARALLEL(Z 16) PQ_DISTRIBUTE(Z NONE) NO_GATHER_OPTIMIZER_STATISTICS */ 
INTO CF_SIMU.VFA_JUDG_RTO_LST Z
SELECT /*+PARALLEL(A 16) */ 
      A.IFRS_ACTS_YYMM, A.PLYNO, A.MPRD_PRDCD, A.IFRS_WRK_SECD, A.MAX_SCN_NUM, '0'
      , A.FV_STD_DVAT, A.INS_DFR_AMT_STD_DVAT, LEAST(A.VFA_JUDG_RTO, 99999)
FROM
    (SELECT /*+PARALLEL(A 16) PARALLEL(B 16) SWAP_JOIN_INPUTS(B) PQ_DISTRIBUTE(B HASH HASH) OPT_PARAM('_OPTIMIZER_ADAPTIVE_PLANS' 'FALSE')*/
          A.IFRS_ACTS_YYMM
          , A.PLYNO
          , A.MPRD_PRDCD
          , A.IFRS_WRK_SECD
          , 0                             AS MAX_SCN_NUM
          , NVL(STDDEV_POP(CASE WHEN A.SCNR_NUM <> 0 THEN A.FND_ITM_FV + NVL(B.FND_ITM_FV, 0) END), 0) AS FV_STD_DVAT
          , NVL(STDDEV_POP(CASE WHEN A.SCNR_NUM <> 0 THEN A.FND_ITM_RLP_INS_DFR_AMT + A.FND_ITM_NO_RLP_INS_DFR_AMT + NVL(B.FND_ITM_RLP_INS_DFR_AMT, 0) + NVL(B.FND_ITM_NO_RLP_INS_DFR_AMT, 0) END), 0) AS INS_DFR_AMT_STD_DVAT
          , NVL(SUM(CASE WHEN A.SCNR_NUM <> 0 THEN (A.FND_ITM_RLP_INS_DFR_AMT + NVL(B.FND_ITM_RLP_INS_DFR_AMT, 0)) END) / DECODE(SUM(CASE WHEN A.SCNR_NUM <> 0 THEN A.FND_ITM_RLP_INS_DFR_AMT + A.FND_ITM_NO_RLP_INS_DFR_AMT + NVL(B.FND_ITM_RLP_INS_DFR_AMT, 0) + NVL(B.FND_ITM_NO_RLP_INS_DFR_AMT, 0) END)
                                                                                                                                , 0, NULL, SUM(CASE WHEN A.SCNR_NUM <> 0 THEN A.FND_ITM_RLP_INS_DFR_AMT + A.FND_ITM_NO_RLP_INS_DFR_AMT + NVL(B.FND_ITM_RLP_INS_DFR_AMT, 0) + NVL(B.FND_ITM_NO_RLP_INS_DFR_AMT, 0) END)), 0)                                                           
                                          AS AVG_ADJ_RTO
          , NVL(NVL(SUM(CASE WHEN A.SCNR_NUM <> 0 THEN (A.FND_ITM_RLP_INS_DFR_AMT + NVL(B.FND_ITM_RLP_INS_DFR_AMT, 0)) END) / DECODE(SUM(CASE WHEN A.SCNR_NUM <> 0 THEN A.FND_ITM_RLP_INS_DFR_AMT + A.FND_ITM_NO_RLP_INS_DFR_AMT + NVL(B.FND_ITM_RLP_INS_DFR_AMT, 0) + NVL(B.FND_ITM_NO_RLP_INS_DFR_AMT, 0) END)
                                                                                                                                , 0, NULL, SUM(CASE WHEN A.SCNR_NUM <> 0 THEN A.FND_ITM_RLP_INS_DFR_AMT + A.FND_ITM_NO_RLP_INS_DFR_AMT + NVL(B.FND_ITM_RLP_INS_DFR_AMT, 0) + NVL(B.FND_ITM_NO_RLP_INS_DFR_AMT, 0) END)), 0) 
                * NVL(STDDEV_POP(CASE WHEN A.SCNR_NUM <> 0 THEN A.FND_ITM_RLP_INS_DFR_AMT + A.FND_ITM_NO_RLP_INS_DFR_AMT + NVL(B.FND_ITM_RLP_INS_DFR_AMT, 0) + NVL(B.FND_ITM_NO_RLP_INS_DFR_AMT, 0) END)
                / DECODE(STDDEV_POP(CASE WHEN A.SCNR_NUM <> 0 THEN A.FND_ITM_FV + NVL(B.FND_ITM_FV, 0) END), 0, NULL, STDDEV_POP(CASE WHEN A.SCNR_NUM <> 0 THEN A.FND_ITM_FV + NVL(B.FND_ITM_FV, 0) END)), 1), 99999)
                                          AS VFA_JUDG_RTO
    FROM
        (SELECT /*+FULL(A) PARALLEL(A 16) */ 
              IFRS_ACTS_YYMM
              , PLYNO
              , MPRD_PRDCD
              , IFRS_WRK_SECD
              , SCNR_NUM
              , SUM(FND_ITM_FV)                 AS FND_ITM_FV
              , SUM(FND_ITM_RLP_INS_DFR_AMT)    AS FND_ITM_RLP_INS_DFR_AMT
              , SUM(FND_ITM_NO_RLP_INS_DFR_AMT) AS FND_ITM_NO_RLP_INS_DFR_AMT
              FROM CF_SIMU.VFA_APPT_REQS_LST A WHERE IFRS_ACTS_YYMM ='201904' AND IFRS_WRK_SECD ='E'
        GROUP BY IFRS_ACTS_YYMM, PLYNO, MPRD_PRDCD, IFRS_WRK_SECD, SCNR_NUM
        ) A
        ,
        (SELECT /*+PARALLEL(A 16) */
            IFRS_ACTS_YYMM
            , PLYNO
            , MPRD_PRDCD
            , IFRS_WRK_SECD
            , SUM(FND_ITM_FV)                 AS FND_ITM_FV
            , SUM(FND_ITM_RLP_INS_DFR_AMT)    AS FND_ITM_RLP_INS_DFR_AMT
            , SUM(FND_ITM_NO_RLP_INS_DFR_AMT) AS FND_ITM_NO_RLP_INS_DFR_AMT
        FROM
            (SELECT /*+FULL(A) PARALLEL(A 16) */ 
                IFRS_ACTS_YYMM
                , PLYNO
                , MPRD_PRDCD
                , IFRS_WRK_SECD
                , PRDCD
                , SUM(CASE WHEN SCNR_NUM = 0 THEN FND_ITM_FV END)                 AS FND_ITM_FV
                , SUM(CASE WHEN SCNR_NUM = 0 THEN FND_ITM_RLP_INS_DFR_AMT END)    AS FND_ITM_RLP_INS_DFR_AMT
                , SUM(CASE WHEN SCNR_NUM = 0 THEN FND_ITM_NO_RLP_INS_DFR_AMT END) AS FND_ITM_NO_RLP_INS_DFR_AMT
            FROM CF_SIMU.VFA_APPT_REQS_LST A WHERE IFRS_ACTS_YYMM ='201904' AND IFRS_WRK_SECD ='E'
            GROUP BY IFRS_ACTS_YYMM, PLYNO, MPRD_PRDCD, IFRS_WRK_SECD, PRDCD
            HAVING COUNT(SCNR_NUM) = 1      
            ) A
        GROUP BY IFRS_ACTS_YYMM, PLYNO, MPRD_PRDCD, IFRS_WRK_SECD
        ) B
    WHERE A.IFRS_ACTS_YYMM = B.IFRS_ACTS_YYMM (+) 
    AND A.PLYNO = B.PLYNO                     (+)
    AND A.MPRD_PRDCD = B.MPRD_PRDCD           (+)
    AND A.IFRS_WRK_SECD = B.IFRS_WRK_SECD     (+)
    GROUP BY A.IFRS_ACTS_YYMM, A.PLYNO, A.MPRD_PRDCD, A.IFRS_WRK_SECD
    ) A
;

COMMIT;


```
